<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Font imports -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Monument:wght@400&family=Oswald:wght@400&display=swap" rel="stylesheet"/>
  <style>
    /* Branding fonts */
    body, label, input, table, th, td, button {
      font-family: 'Montserrat', sans-serif;
      font-weight: 400;
    }
    h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: normal !important;
      font-style: normal !important;
      letter-spacing: normal !important;
    }
    h3, .subhead, th {
      font-family: 'Oswald', sans-serif;
      font-weight: 400;
      letter-spacing: 0.1em;
    }
  </style>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fit Sheet App - Per Item Nude Color</title>
  <style>
    /* Layout and styling for improved appearance */
    body {
      font-family: Arial, sans-serif;
      background-color: #4c2e83;
      color: white;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      color: black;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
    }
    th {
      background: #eee;
    }
    input[type="text"], input[type="number"] {
      width: 95%;
      padding: 3px;
    }
    button {
      margin: 10px 0;
      padding: 6px 12px;
      background: #4c2e83;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #3b2268;
    }
    .hidden {
      display: none;
    }
    .new-row-highlight {
      background: #d1c4e9;
    }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom:10px;">
    <img src="rebel-mark-WHITE.png" alt="Rebel Star Logo" style="max-height:100px; margin-bottom:10px;" />
  </div>
  <h1>ATHLETE FIT SHEET</h1>
  <h3>Order Details</h3>
  <table>
    <tr>
      <th>Account Manager</th>
      <td><input type="text" id="accountManager" /></td>
    </tr>
    <tr>
      <th>Account</th>
      <td><input type="text" id="gymCompany" /></td>
      <th>Contact</th>
      <td><input type="text" id="coachOwner" /></td>
    </tr>
    <tr>
      <th>Date</th>
      <td><input type="date" id="orderDate" /></td>
      <th>Event Date</th>
      <td><input type="date" id="eventDate" /></td>
    </tr>
    <tr>
      <th>Salesforce Opportunity Link</th>
      <td colspan="3">
        <input type="text" id="sfOpportunityId" placeholder="Salesforce Opportunity ID" oninput="updateOpportunityLink()" />
        <div id="sfLinkDisplay" style="margin-top:5px;"></div>
      </td>
    </tr>
    <tr>
      <th>Art Approval PDF</th>
      <td colspan="3">
        <input type="file" id="artApprovalPdf" accept="application/pdf" />
        <div id="pdfFileName" style="margin-top:5px;"></div>
      </td>
    </tr>
    <tr>
      <th>Order Description</th>
      <td colspan="3"><input type="text" id="orderDescription" /></td>
    </tr>
  </table>
  <h3>Items (Up to 4)</h3>
  <table id="itemsTable">
    <thead>
      <tr>
        <th>Item #</th>
        <th>Description</th>
        <th>Include Nude Color</th>
        <th>Image</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" id="item1Number" oninput="updateItemHeaders()" /></td>
        <td><input type="text" id="item1Desc" oninput="updateItemHeaders()" /></td>
        <td style="text-align:center;"><input type="checkbox" id="nudeItem1" onchange="toggleNudeColor(1)" /></td>
        <td>
          <input type="file" id="item1Image" accept="image/*" onchange="previewItemImage(1)" />
          <div id="item1ImagePreview" style="margin-top:5px;"></div>
        </td>
      </tr>
      <tr>
        <td><input type="text" id="item2Number" oninput="updateItemHeaders()" /></td>
        <td><input type="text" id="item2Desc" oninput="updateItemHeaders()" /></td>
        <td style="text-align:center;"><input type="checkbox" id="nudeItem2" onchange="toggleNudeColor(2)" /></td>
        <td>
          <input type="file" id="item2Image" accept="image/*" onchange="previewItemImage(2)" />
          <div id="item2ImagePreview" style="margin-top:5px;"></div>
        </td>
      </tr>
      <tr>
        <td><input type="text" id="item3Number" oninput="updateItemHeaders()" /></td>
        <td><input type="text" id="item3Desc" oninput="updateItemHeaders()" /></td>
        <td style="text-align:center;"><input type="checkbox" id="nudeItem3" onchange="toggleNudeColor(3)" /></td>
        <td>
          <input type="file" id="item3Image" accept="image/*" onchange="previewItemImage(3)" />
          <div id="item3ImagePreview" style="margin-top:5px;"></div>
        </td>
      </tr>
      <tr>
        <td><input type="text" id="item4Number" oninput="updateItemHeaders()" /></td>
        <td><input type="text" id="item4Desc" oninput="updateItemHeaders()" /></td>
        <td style="text-align:center;"><input type="checkbox" id="nudeItem4" onchange="toggleNudeColor(4)" /></td>
        <td>
          <input type="file" id="item4Image" accept="image/*" onchange="previewItemImage(4)" />
          <div id="item4ImagePreview" style="margin-top:5px;"></div>
        </td>
      </tr>
    </tbody>
  </table>
  <table id="athletesTable">
    <thead>
      <tr>
        <th>Athlete Name</th>
        <th class="nudeHeader1 hidden">Nude Color 1</th>
        <th class="itemHeader">Item 1 Size</th>
        <th class="itemHeader">Item 1 Qty</th>
        <th class="nudeHeader2 hidden">Nude Color 2</th>
        <th class="itemHeader">Item 2 Size</th>
        <th class="itemHeader">Item 2 Qty</th>
        <th class="nudeHeader3 hidden">Nude Color 3</th>
        <th class="itemHeader">Item 3 Size</th>
        <th class="itemHeader">Item 3 Qty</th>
        <th class="nudeHeader4 hidden">Nude Color 4</th>
        <th class="itemHeader">Item 4 Size</th>
        <th class="itemHeader">Item 4 Qty</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="athletesTbody"></tbody>
  </table>
  <button type="button" id="addAthleteBtn">Add Athlete</button>
  <button type="button" id="summaryBtn">Compute Summary</button>
  <button type="button" id="exportCsvBtn">Export CSV</button>
  <section id="summarySection"></section>

  <script>
    function toggleNudeColor(itemIndex) {
      const header = document.querySelector('.nudeHeader' + itemIndex);
      const show = document.getElementById('nudeItem' + itemIndex).checked;
      header.classList.toggle('hidden', !show);
      const rows = document.querySelectorAll('#athletesTbody tr');
      rows.forEach(row => {
        const cell = row.querySelector('.nudeCell' + itemIndex);
        if (cell) cell.classList.toggle('hidden', !show);
      });
    }

    function addAthleteRow() {
      const tbody = document.getElementById('athletesTbody');
      const row = document.createElement('tr');

      function createCell(type = 'text', cls = '') {
        const td = document.createElement('td');
        if (cls) td.classList.add(cls);
        const input = document.createElement('input');
        input.type = type;
        if (type === 'number') input.min = 0;
        td.appendChild(input);
        return td;
      }

      // Athlete Name
      row.appendChild(createCell('text'));

      // For each item: Nude, Size, Qty
      for (let i = 1; i <= 4; i++) {
        const nudeCell = createCell('text', 'nudeCell' + i);
        if (!document.getElementById('nudeItem' + i).checked) nudeCell.classList.add('hidden');
        row.appendChild(nudeCell);
        row.appendChild(createCell('text'));
        row.appendChild(createCell('number'));
      }

      // Remove button
      const removeTd = document.createElement('td');
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'X';
      removeBtn.type = 'button';
      removeBtn.onclick = () => tbody.removeChild(row);
      removeTd.appendChild(removeBtn);
      row.appendChild(removeTd);

      tbody.appendChild(row);
      row.classList.add('new-row-highlight');
      setTimeout(() => row.classList.remove('new-row-highlight'), 2000);
    }

    function updateItemHeaders() {
      const headers = document.querySelectorAll('#athletesTable thead tr th.itemHeader');
      // Update the headers for each item using the custom number/description. Each item has two itemHeader columns (Size and Qty).
      for (let i = 1; i <= 4; i++) {
        const num = document.getElementById('item' + i + 'Number').value.trim();
        const desc = document.getElementById('item' + i + 'Desc').value.trim();
        const label = (desc || num) ? ((desc && num) ? `${desc} (${num})` : (desc || num)) : `Item ${i}`;
        // Update nude color header text
        const nudeHeader = document.querySelector('.nudeHeader' + i);
        if (nudeHeader) {
          nudeHeader.innerText = label + ' Nude Color';
        }
        // Update size and quantity headers. There are two itemHeader elements per item.
        headers[(i - 1) * 2].innerText = label + ' Size';
        headers[(i - 1) * 2 + 1].innerText = label + ' Qty';
      }
    }

    function computeSummary() {
      const rows = document.querySelectorAll('#athletesTbody tr');
      const summary = {};
      rows.forEach(row => {
        const cells = row.querySelectorAll('td input');
        let offset = 1;
        for (let i = 1; i <= 4; i++) {
          offset++;
          const size = cells[offset].value.trim();
          const qty = parseInt(cells[offset + 1].value, 10) || 0;
          if (size) {
            if (!summary[i]) summary[i] = {};
            summary[i][size] = (summary[i][size] || 0) + qty;
          }
          offset += 2;
        }
      });
      let html = '<h3>Size Summary</h3>';
      // For each item summary, use the custom label instead of generic "Item i".
      for (const item in summary) {
        const idx = parseInt(item);
        const num  = document.getElementById('item' + idx + 'Number').value.trim();
        const desc = document.getElementById('item' + idx + 'Desc').value.trim();
        const label = (desc || num) ? ((desc && num) ? `${desc} (${num})` : (desc || num)) : `Item ${idx}`;
        html += `<h4>${label}</h4><table><tr><th>Size</th><th>Total Qty</th></tr>`;
        for (const size in summary[item]) {
          html += `<tr><td>${size}</td><td>${summary[item][size]}</td></tr>`;
        }
        html += '</table>';
      }
      if (!rows.length) html += '<p>No athlete data available.</p>';
      document.getElementById('summarySection').innerHTML = html;
    }

    function exportSummaryToCSV() {
      /*
        Build a CSV export containing:
        1. Order-level details from the top of the form.
        2. A table of each athlete with their size, quantity and nude color selections per item.
        3. A summary of sizes per item (the same as the onâ€‘page summary).  
        This ensures the exported CSV includes all relevant information for recreating the Fit Sheet in a spreadsheet.
      */

      // Collect top-level order details
      const accountManager = document.getElementById('accountManager').value.trim();
      const accountName    = document.getElementById('gymCompany').value.trim();
      const contactName    = document.getElementById('coachOwner').value.trim();
      const orderDate      = document.getElementById('orderDate').value;
      const eventDate      = document.getElementById('eventDate').value;
      const oppId          = document.getElementById('sfOpportunityId').value.trim();
      const orderDesc      = document.getElementById('orderDescription').value.trim();
      const artFileInput   = document.getElementById('artApprovalPdf');
      const artFileName    = artFileInput && artFileInput.files && artFileInput.files[0] ? artFileInput.files[0].name : '';

      let csv = '';
      // Append order details as key,value lines
      csv += 'Account Manager,"' + accountManager + '"\n';
      csv += 'Account,"' + accountName + '"\n';
      csv += 'Contact,"' + contactName + '"\n';
      csv += 'Date,"' + orderDate + '"\n';
      csv += 'Event Date,"' + eventDate + '"\n';
      csv += 'Salesforce Opportunity Link,"' + oppId + '"\n';
      csv += 'Art Approval PDF,"' + artFileName + '"\n';
      csv += 'Order Description,"' + orderDesc + '"\n\n';

      // Ensure the on-page summary is up to date
      computeSummary();
      // Recompute summary data locally so we can output custom labels in the CSV. This avoids relying on DOM tables.
      const summaryData = {};
      const athRows = document.querySelectorAll('#athletesTbody tr');
      athRows.forEach(row => {
        const cells = row.querySelectorAll('td input');
        let offset = 1;
        for (let i = 1; i <= 4; i++) {
          offset++; // skip nude color cell
          const size = cells[offset].value.trim();
          const qty = parseInt(cells[offset + 1].value, 10) || 0;
          if (size) {
            if (!summaryData[i]) summaryData[i] = {};
            summaryData[i][size] = (summaryData[i][size] || 0) + qty;
          }
          offset += 2;
        }
      });
      // Append summary using custom item labels
      for (let i = 1; i <= 4; i++) {
        if (!summaryData[i]) continue;
        const num = document.getElementById('item' + i + 'Number').value.trim();
        const desc = document.getElementById('item' + i + 'Desc').value.trim();
        const label = (desc || num) ? ((desc && num) ? `${desc} (${num})` : (desc || num)) : `Item ${i}`;
        csv += label + ' Summary\n';
        csv += '"Size","Total Qty"\n';
        for (const size in summaryData[i]) {
          csv += '"' + size + '","' + summaryData[i][size] + '"\n';
        }
        csv += '\n';
      }

      // Build athlete header row after summaries using custom item labels
      const header = ['Athlete Name'];
      for (let i = 1; i <= 4; i++) {
        const num = document.getElementById('item' + i + 'Number').value.trim();
        const desc = document.getElementById('item' + i + 'Desc').value.trim();
        const label = (desc || num) ? ((desc && num) ? `${desc} (${num})` : (desc || num)) : `Item ${i}`;
        header.push(label + ' Size');
        header.push(label + ' Qty');
        header.push(label + ' Nude Color');
      }
      csv += header.map(h => '"' + h + '"').join(',') + '\n';

      // Gather athlete rows
      const bodyRows = document.querySelectorAll('#athletesTbody tr');
      bodyRows.forEach(row => {
        const inputs = row.querySelectorAll('td input');
        const rowVals = [];
        // Athlete name
        rowVals.push(inputs[0].value.trim());
        let offset = 1;
        for (let i = 1; i <= 4; i++) {
          const nudeColor = inputs[offset].value.trim();
          const size      = inputs[offset + 1].value.trim();
          const qtyVal    = inputs[offset + 2].value.trim();
          rowVals.push(size);
          rowVals.push(qtyVal);
          rowVals.push(nudeColor);
          offset += 3;
        }
        csv += rowVals.map(v => '"' + v + '"').join(',') + '\n';
      });
      csv += '\n';
      // Create and trigger download with dynamic filename
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      // Build a descriptive filename: AFS_<AccountName>_<ItemNumbers>_<YYYY-MM-DD>.csv
      const acct = document.getElementById('gymCompany').value.trim().replace(/\s+/g, '');
      const itemNums = [];
      for (let i = 1; i <= 4; i++) {
        const num = document.getElementById('item' + i + 'Number').value.trim();
        if (num) itemNums.push(num.replace(/\s+/g, ''));
      }
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      let fileName = 'AFS_' + (acct || 'Unknown');
      if (itemNums.length) fileName += '_' + itemNums.join('_');
      fileName += '_' + dateStr + '.csv';
      link.download = fileName;
      link.click();
    }

    document.getElementById('addAthleteBtn').addEventListener('click', addAthleteRow);
    document.getElementById('summaryBtn').addEventListener('click', computeSummary);
    document.getElementById('exportCsvBtn').addEventListener('click', exportSummaryToCSV);

    function updateOpportunityLink() {
      const input = document.getElementById('sfOpportunityId');
      const val = input.value.trim();
      const linkDiv = document.getElementById('sfLinkDisplay');
      linkDiv.innerHTML = '';
      if (val) {
        const link = document.createElement('a');
        link.href = 'https://login.salesforce.com/' + val;
        link.target = '_blank';
        link.style.color = 'white';
        link.style.textDecoration = 'underline';
        link.innerText = 'Open Opportunity in Salesforce';
        linkDiv.appendChild(link);
      }
    }

    document.getElementById('artApprovalPdf').addEventListener('change', function () {
      const fileDiv = document.getElementById('pdfFileName');
      fileDiv.innerHTML = '';
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const link = document.createElement('a');
        link.href = URL.createObjectURL(file);
        link.download = file.name;
        link.innerText = file.name + ' (click to download)';
        link.style.color = 'white';
        link.style.textDecoration = 'underline';
        fileDiv.appendChild(link);
      }
    });

    function previewItemImage(index) {
      const input = document.getElementById('item' + index + 'Image');
      const previewDiv = document.getElementById('item' + index + 'ImagePreview');
      previewDiv.innerHTML = '';
      if (input.files && input.files[0]) {
        const img = document.createElement('img');
        img.style.maxHeight = '60px';
        img.style.marginLeft = '10px';
        const reader = new FileReader();
        reader.onload = function (e) {
          img.src = e.target.result;
          previewDiv.appendChild(img);
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
  </script>
</body>
</html>
